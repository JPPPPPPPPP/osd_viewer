<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSeadragon | Backblaze B2 Viewer</title>
    <style>
        /* Ensure the viewer takes up the full browser window */
        body, html, #openseadragon-viewer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: black;
        }
    </style>
</head>
<body>

    <div id="openseadragon-viewer"></div>

    <script src="openseadragon.min.js"></script>

    <script>
        // Global reference for Unity/external calls
        window.viewer = null;

        window.onload = function() {
            const dziUrl = "https://f003.backblazeb2.com/file/Tile-Pyramids/CTC_tiles.dzi";

            window.viewer = OpenSeadragon({
                id: "openseadragon-viewer",
                tileSources: dziUrl,
                
                // UI & Interaction Settings
                showNavigationControl: false, // Hidden for VR/Unity setup
                immediateRender: true,      
                defaultZoomLevel: 1,
                minZoomLevel: 1,
                maxZoomLevel: 20,
                
                // Performance & Quality Settings
                minPixelRatio: 0.5,
                imageSmoothingEnabled: true,
                maxImageCacheCount: 200,
                
                // Cross-Origin (CORS) setting
                crossOriginPolicy: 'Anonymous',
                loadTilesWithAjax: true
            });

            // --- BLOCK DEFAULT INTERACTION ---
            // This prevents Unity pointer from dragging/scrolling
            var cancelAction = function(e) { e.preventDefaultAction = true; };
            window.viewer.addHandler('canvas-drag', cancelAction);
            window.viewer.addHandler('canvas-click', cancelAction);
            window.viewer.addHandler('canvas-scroll', cancelAction);
        };

        /**
         * The Zoom Function (For Unity/External Input)
         * x, y: UV coordinates (0 to 1)
         * multiplier: >1 to zoom in, <1 to zoom out
         */
        window.relativeZoomAtPoint = function(x, y, multiplier) {
            if (window.viewer && window.viewer.viewport) {
                // Convert 0-1 UVs to actual pixel coordinates in the viewer container
                var viewerPoint = new OpenSeadragon.Point(
                    x * window.viewer.container.clientWidth, 
                    y * window.viewer.container.clientHeight
                );

                // Translate that to the internal Viewport coordinate system
                var viewportPoint = window.viewer.viewport.viewerElementToViewportCoordinates(viewerPoint);

                // Apply the zoom
                window.viewer.viewport.zoomBy(multiplier, viewportPoint);
                window.viewer.viewport.applyConstraints();
            }
        };
        
        /**
         * Reset function to return to the original full view
         */
        window.resetMap = function() {
            if (window.viewer && window.viewer.viewport) {
                window.viewer.viewport.goHome(false); // Set to true for instant snap
            }
        };
    </script>
</body>
</html>